/*! dossier-forense.poc.v1.js */(function(){function e(e){document.readyState==='complete'?e():addEventListener('load',e,{once:!0})}async function t(e){const t='string'==typeof e?new TextEncoder().encode(e):e,n=await crypto.subtle.digest('SHA-256',t);return[...new Uint8Array(n)].map((e=>e.toString(16).padStart(2,'0'))).join('')}function n(e){if(null===e||'object'!=typeof e)return e;if(Array.isArray(e))return e.map(n);const t={};return Object.keys(e).sort().forEach((e=>{t[e]=n(e[e])})),t}async function o(e){const t=e?.files?.[0];if(!t)return null;const n=await t.arrayBuffer();return{name:t.name,size:t.size,type:t.type,sha256:await (await crypto.subtle.digest('SHA-256',n)).byteLength&&await (async e=>{const t=new Uint8Array(await crypto.subtle.digest('SHA-256',e));return[...t].map((e=>e.toString(16).padStart(2,'0'))).join('')})(n)}}async function a(e,n,o,r){try{const a='dossiers';await e.storage.from(a).upload(n+'.json',new Blob([o],{type:'application/json'}),{upsert:!0}),r?.files?.[0]&&await e.storage.from(a).upload(n+'-hin.jpg',r.files[0],{upsert:!0});return!0}catch(e){return console.warn('[dossier] upload falhou:',e),!1}}function s(e,n,o){const a=document.createElement('a'),s=new Blob([o],{type:n});a.href=URL.createObjectURL(s),a.download=e,a.click(),setTimeout((()=>URL.revokeObjectURL(a.href)),2e3)}function r(e,t,n){const o=e=>e.replace(/[&<>]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e])));return"<!DOCTYPE html><html lang=\"pt\"><meta charset=\"utf-8\"><title>Dossier — "+t.slice(0,12)+"…</title><style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;max-width:880px;margin:auto}pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto;max-height:60vh}</style><h1>Dossier Forense <small>— M.I.E.C.</small></h1><p><b>SHA-256:</b> <code>"+t+"</code></p><div id=\"qr\"></div><p>Verificar: <a href=\""+e+"\">"+e+"</a></p><pre>"+o(n)+"</pre><script>"window.QRCodeTextCanvas=function(e,t,n){var r=document.createElement('canvas');r.width=r.height=n;var a=r.getContext('2d');a.fillStyle='#fff',a.fillRect(0,0,n,n),a.fillStyle='#000';for(var i=0;i<n;i+=10)for(var o=0;o<n;o+=10)(i+o)%20==0&&a.fillRect(i,o,8,8);e.innerHTML='',e.appendChild(r);return r};</script><script>(function(){var e=document.getElementById('qr');QRCodeTextCanvas(e,'"+e+"',180)})();</script>"}e((()=>{const e=document.getElementById('dossierBtn');e&&e.addEventListener('click',async()=>{try{e.disabled=!0,e.textContent='A gerar…';const r=window.MIEC_SYNC?.client||window.supabaseClient||null,i=r?(await r.auth.getSession()).data.session:null,c=i?.user?.id||null,d={app:'MIEC',version:'r13',ts:Date.now(),user_id:c,hin:(document.getElementById('winInput')?.value||'').trim(),win_cert_presented:!!document.getElementById('winCert')?.checked,cert_number:(document.getElementById('certNumber')?.value||'').trim(),cert_issuer:(document.getElementById('certIssuer')?.value||'').trim(),motor_brand:(document.getElementById('brand')?.value||'').trim(),motor_ident:(document.querySelector('#brandFields input')?.value||'').trim(),win_photo:await o(document.getElementById('winPhoto'))},l=n(d),u=JSON.stringify(l),p=await t(u);r&&await a(r,p,u,document.getElementById('winPhoto'));const y=(location.origin||'')+'/verify.html?sha='+p,m=r(y,p,(e=>e.replace(/[&<>]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e]))))(JSON.stringify(l,null,2)));s('dossier-'+p+'.html','text/html',m)}catch(t){alert('Falhou gerar dossier: '+(t.message||t))}finally{e.disabled=!1,e.textContent='Gerar Dossier'}})}));})();