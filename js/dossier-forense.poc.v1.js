/*! dossier-forense.poc.v1.js */(function(){function e(e){'complete'===document.readyState?e():addEventListener('load',e,{once:!0})}async function t(e){const t='string'==typeof e?new TextEncoder().encode(e):e,n=await crypto.subtle.digest('SHA-256',t);return[...new Uint8Array(n)].map((e=>e.toString(16).padStart(2,'0'))).join('')}function n(e){if(null===e||'object'!=typeof e)return e;if(Array.isArray(e))return e.map(n);const t={};return Object.keys(e).sort().forEach((r=>{t[r]=n(e[r])})),t}function r(e){return new Promise((async n=>{const r=e&&e.files&&e.files[0];if(!r)return n(null);const o=await r.arrayBuffer(),a=await t(o);n({name:r.name,size:r.size,type:r.type,sha256:a})}))}async function o(e,t,n,r,o){try{const a='dossiers';await e.storage.from(a).upload(t+'.json',new Blob([n],{type:'application/json'}),{upsert:!0}),r&&r.files&&r.files[0]&&await e.storage.from(a).upload(t+'-hin.jpg',r.files[0],{upsert:!0}),o&&o.files&&o.files[0]&&await e.storage.from(a).upload(t+'-motor.jpg',o.files[0],{upsert:!0});return!0}catch(a){return console.warn('[dossier] upload falhou:',a),!1}}function a(e,t,n){const r=document.createElement('a'),o=new Blob([n],{type:t});r.href=URL.createObjectURL(o),r.download=e,r.click(),setTimeout((()=>URL.revokeObjectURL(r.href)),2e3)}function i(e,t,n){return`<!DOCTYPE html><html lang="pt"><meta charset="utf-8"><title>Dossier Forense — ${t.slice(0,12)}…</title><style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;max-width:880px;margin:auto} .grid{display:grid;grid-template-columns:1fr 200px;gap:16px;align-items:start} pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto;max-height:50vh} .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef} .ok{color:#0a0}</style><h1>Dossier Forense <small class="pill">M.I.E.C.</small></h1><p><b>Hash (SHA-256):</b> <code>${t}</code></p><div class="grid"><pre>${n.replace(/[&<>]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e])))}</pre><div id="qr"></div></div><p>Verificar em: <a href="${e}">${e}</a></p><script>function QRCodeTextCanvas(e,t,n){var r=document.createElement('canvas');r.width=r.height=n;var a=r.getContext('2d');a.fillStyle='#000',a.fillRect(0,0,10,10),e.appendChild(r);return r}</script><script>(function(){var e=document.getElementById('qr'); QRCodeTextCanvas(e, '${e}', 180);})();</script>`}e((()=>{const e=document.getElementById('dossierBtn');e&&e.addEventListener('click',(async()=>{try{e.disabled=!0,e.textContent='A gerar...';const s=(window.MIEC_SYNC&&window.MIEC_SYNC.client)||window.supabaseClient,c=s?(await s.auth.getSession()).data.session:null,d=(null==c?void 0:c.user)?c.user.id:null,u={app:'MIEC',version:'r13-poc',ts:Date.now(),user_id:d,hin:(document.getElementById('winInput')||{}).value||'',win_cert_presented:!!(document.getElementById('winCert')||{}).checked,cert_number:(document.getElementById('certNumber')||{}).value||'',cert_issuer:(document.getElementById('certIssuer')||{}).value||'',motor_brand:(document.getElementById('brand')||{}).value||'',motor_ident:((document.querySelector('#brandFields input')||{}).value)||''},l=document.getElementById('winPhoto'),m=document.getElementById('motorPhoto');u.win_photo=await r(l),u.motor_photo=await r(m);const p=n(u),f=JSON.stringify(p),y=await t(f);s&&await o(s,y,f,l,m);const h=(location.origin||'')+'/verify.html?sha='+y,g=i(h,y,JSON.stringify(p,null,2));a('dossier-'+y+'.html','text/html',g);try{s&&await s.from('forensic_dossiers').upsert({sha256:y,user_id:d,ts:u.ts,kind:u.hin?'HIN':u.motor_brand?'MOTOR':'NA',hin:u.hin||null,brand:u.motor_brand||null,ident:u.motor_ident||null},{onConflict:'sha256'})}catch(v){console.warn('[dossier] upsert metadados falhou:',v)}e.textContent='Gerar Dossier',e.disabled=!1,alert('Dossier gerado. Foi descarregado um HTML e, se possível, foi guardado no bucket "dossiers".')}catch(w){e.textContent='Gerar Dossier',e.disabled=!1,alert('Falhou gerar dossier: '+(w.message||w))}}))}))})();