<!DOCTYPE html>
<html lang="pt"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>M.I.E.C. • Verificar Dossier</title>
<link rel="stylesheet" href="css/styles.css">
<style>body{max-width:900px;margin:24px auto;padding:0 16px;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto}.ok{color:#0a0}.bad{color:#a00}</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.56.0"></script>
<script defer src="js/config.js?v=418"></script></head>
<body><h1>Verificador de Dossier</h1><p>Recalcula o <b>SHA-256</b> do JSON e compara com <code>?sha=</code>.</p>
<div id="status"></div><pre id="jsonview"></pre>
<script>
async function sha256hex(s){const e=new TextEncoder().encode(s),b=await crypto.subtle.digest('SHA-256',e);return[...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,'0')).join('')}
async function main(){
  const p=new URLSearchParams(location.search), sha=(p.get('sha')||'').trim().toLowerCase();
  const status=document.getElementById('status'), pre=document.getElementById('jsonview');
  if(!sha){ status.innerHTML='<p class="bad">Falta parâmetro <code>sha</code>.</p>'; return; }
  const sb=window.supabaseClient||(window.SUPABASE_URL&&window.SUPABASE_ANON_KEY? supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY):null);
  if(!sb){ status.innerHTML='<p>Sem cliente Supabase.</p>'; return; }
  try{
    const { data, error } = await sb.storage.from('dossiers').download(sha+'.json');
    if(error) throw error;
    const text=await data.text();
    pre.textContent=text;
    const calc=await sha256hex(text);
    status.innerHTML = (calc===sha)? '<p class="ok">✅ Válido</p>' : '<p class="bad">❌ Inválido</p><p><small>Calculado: '+calc+'</small></p>';
  }catch(e){ status.innerHTML='<p class="bad">Erro: '+(e.message||e)+'</p>'; }
}
addEventListener('load', main);
</script></body></html>
